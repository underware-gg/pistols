#!/bin/bash
set -e

#-----------------
# env setup
#
export WORLD_ADDRESS=$(toml get Scarb.toml --raw tool.dojo.env.world_address)
export RPC_URL=$(toml get Scarb.toml --raw tool.dojo.env.rpc_url)
export LORDS_ADDRESS=$(toml get Scarb.toml --raw tool.dojo.env.lords_address)

#-----------------
# if $LORDS is not defined, we need to mock it
#
if [[ -z "$LORDS_ADDRESS" ]]; then
  cd ../lords_mock
  ./migrate
  cd -
fi

#-----------------
# migrate
#
echo "------------------------------------------------------------------------------"
echo "Migrating..."
sozo migrate --world $WORLD_ADDRESS

#-----------------
# auth write
#
scripts/default_auth.sh

#-----------------
# client update
#
cp target/dev/manifest.json ../client/src/
cd ../client
npm run create-components $RPC_URL $WORLD_ADDRESS

#-----------------
echo "--- DONE! üëç"
