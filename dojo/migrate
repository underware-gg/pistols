#!/bin/bash
set -e

# Profile
if [ $# -ge 1 ]; then
  export PROFILE=$1
else
  export PROFILE="dev"
fi

if ! [ -x "$(command -v toml)" ]; then
  echo 'Error: toml not instlaled! Instal with: cargo install toml-cli'
  exit 1
fi

get_profile_env () {
  local ENV_NAME=$1
  local RESULT=$(toml get Scarb.toml --raw profile.$PROFILE.tool.dojo.env.$ENV_NAME)
  if [[ -z "$RESULT" ]]; then
    local RESULT=$(toml get Scarb.toml --raw tool.dojo.env.$ENV_NAME)
    if [[ -z "$RESULT" ]]; then
      >&2 echo "get_profile_env($ENV_NAME) not found! üëé"
    fi
  fi
  echo $RESULT
}

#-----------------
# env setup
#
export GAME_SLUG="pistols"
export MANIFEST_FILE_PATH="./manifests/$PROFILE/deployment/manifest.json"
export BINDINGS_PATH="./bindings/typescript"
export CLIENT_GEN_PATH="../client/src/games/$GAME_SLUG/generated"
export PROFILE_GEN_PATH="$CLIENT_GEN_PATH/$PROFILE"
export PROJECT_NAME=$(toml get Scarb.toml --raw tool.dojo.world.name)
export WORLD_ADDRESS=$(get_profile_env "world_address")
# use $STARKNET_RPC_URL else read from profile
export RPC_URL=${STARKNET_RPC_URL:-$(get_profile_env "rpc_url")}

echo "------------------------------------------------------------------------------"
echo "PROJECT: $PROJECT_NAME"
echo "PROFILE: $PROFILE"
echo "RPC_URL: $RPC_URL"
echo "WORLD_ADDRESS: $WORLD_ADDRESS"
echo "CLIENT_GEN_PATH: $CLIENT_GEN_PATH"
echo "PROFILE_GEN_PATH: $PROFILE_GEN_PATH"
echo "BINDINGS_PATH: $BINDINGS_PATH"
echo ""

if [[
  -z "$PROJECT_NAME" ||
  -z "$PROFILE" ||
  -z "$MANIFEST_FILE_PATH" ||
  "$WORLD_ADDRESS" != "0x"* ||
  "$RPC_URL" != "http"*
]]; then
  echo "! Missing data üëé"
  exit 1
fi

#-----------------
# build
#
echo "------------------------------------------------------------------------------"
echo ">>> Cleaning..."
sozo -P $PROFILE clean
echo ">>> Building..."
if [[ "$PROFILE" == "dev" ]]; then
  sozo -P $PROFILE build --typescript
else
  sozo -P $PROFILE build
fi
echo "üëç"

#-----------------
# migrate
#
echo "------------------------------------------------------------------------------"
echo ">>> Migrating..."
# sozo --profile $PROFILE migrate plan --world $WORLD_ADDRESS
# exit 0
sozo -P $PROFILE migrate apply --world $WORLD_ADDRESS
echo "üëç"

#-----------------
# auth write
#
# scripts/default_auth.sh $PROFILE


#------------------------
# copy manifest to client
#
echo "------------------------------------------------------------------------------"
echo ">>> Copying manifest [$MANIFEST_FILE_PATH] to [$PROFILE_GEN_PATH/]"
mkdir -p $PROFILE_GEN_PATH
cp $MANIFEST_FILE_PATH $PROFILE_GEN_PATH/
echo "üëç"

#------------------------
# typescript bindings
#
if [[ "$PROFILE" == "dev" ]]; then
  #
  # TODO: Enable this when bindings are ported
  # generate and copy bindings
  # cp $BINDINGS_PATH/* $CLIENT_GEN_PATH/
  #
  # copy to client
  echo "------------------------------------------------------------------------------"
  echo ">>> Generate sources..."
  cd ../client
  npm run create-components --game=$GAME_SLUG --profile=$PROFILE $RPC_URL $WORLD_ADDRESS
  npm run create-constants --game=$GAME_SLUG --profile=$PROFILE
  echo "üëç?"
  #
  # list copied files
  echo "------------------------------------------------------------------------------"
  ls -ld $CLIENT_GEN_PATH/* | grep -E 'ts|json'
fi


#------------------
echo "--- DONE! üëç"
